From: Jordan Santell <jsantell@mozilla.com>
Date: Tue, 13 Oct 2015 14:30:40 -0700
Subject: Bug 1214231 - Provide an option to generate census tree nodes in a worker when taking a census. r=fitzgen

diff --git a/devtools/shared/heapsnapshot/HeapAnalysesClient.js b/devtools/shared/heapsnapshot/HeapAnalysesClient.js
index 35cd446..5bc3518 100644
--- a/devtools/shared/heapsnapshot/HeapAnalysesClient.js
+++ b/devtools/shared/heapsnapshot/HeapAnalysesClient.js
@@ -58,18 +58,29 @@ HeapAnalysesClient.prototype.readHeapSnapshot = function (snapshotFilePath) {
  *
  * @param {String} snapshotFilePath
  *
  * @param {Object} censusOptions
  *        A structured-cloneable object specifying the requested census's
  *        breakdown. See the "takeCensus" section of
  *        `js/src/doc/Debugger/Debugger.Memory.md` for detailed documentation.
  *
- * @returns Promise<census report>
- *          The report generated by the given census breakdown.
+ * @param {Object} requestOptions
+ *        An object specifying options of this worker request.
+ *        - {Boolean} asTreeNode
+ *          Whether or not the census is returned as a CensusTreeNode,
+ *          or just a breakdown report. Defaults to false.
+ *          @see `devtools/shared/heapsnapshot/census-tree-node.js`
+ *
+ * @returns Promise<census report|CensusTreeNode>
+ *          The report generated by the given census breakdown, or
+ *          a CensusTreeNode generated by the given census breakdown
+ *          if `asTreeNode` is true.
  */
 HeapAnalysesClient.prototype.takeCensus = function (snapshotFilePath,
-                                                    censusOptions) {
+                                                    censusOptions={},
+                                                    requestOptions={}) {
   return this._worker.performTask("takeCensus", {
     snapshotFilePath,
-    censusOptions
+    censusOptions,
+    requestOptions,
   });
 };
diff --git a/devtools/shared/heapsnapshot/HeapAnalysesWorker.js b/devtools/shared/heapsnapshot/HeapAnalysesWorker.js
index b2a4e07..146a8a3 100644
--- a/devtools/shared/heapsnapshot/HeapAnalysesWorker.js
+++ b/devtools/shared/heapsnapshot/HeapAnalysesWorker.js
@@ -5,17 +5,19 @@
 
 // This is a worker which reads offline heap snapshots into memory and performs
 // heavyweight analyses on them without blocking the main thread. A
 // HeapAnalysesWorker is owned and communicated with by a HeapAnalysesClient
 // instance. See HeapAnalysesClient.js.
 
 "use strict";
 
+importScripts("resource://gre/modules/workers/require.js");
 importScripts("resource://gre/modules/devtools/shared/worker/helper.js");
+const { CensusTreeNode } = require("resource://gre/modules/devtools/shared/heapsnapshot/census-tree-node.js");
 
 // The set of HeapSnapshot instances this worker has read into memory. Keyed by
 // snapshot file path.
 const snapshots = Object.create(null);
 
 /**
  * @see HeapAnalysesClient.prototype.readHeapSnapshot
  */
@@ -23,15 +25,16 @@ workerHelper.createTask(self, "readHeapSnapshot", ({ snapshotFilePath }) => {
   snapshots[snapshotFilePath] =
     ThreadSafeChromeUtils.readHeapSnapshot(snapshotFilePath);
   return true;
 });
 
 /**
  * @see HeapAnalysesClient.prototype.takeCensus
  */
-workerHelper.createTask(self, "takeCensus", ({ snapshotFilePath, censusOptions }) => {
+workerHelper.createTask(self, "takeCensus", ({ snapshotFilePath, censusOptions, requestOptions }) => {
   if (!snapshots[snapshotFilePath]) {
     throw new Error(`No known heap snapshot for '${snapshotFilePath}'`);
   }
 
-  return snapshots[snapshotFilePath].takeCensus(censusOptions);
+  let report = snapshots[snapshotFilePath].takeCensus(censusOptions);
+  return requestOptions.asTreeNode ? new CensusTreeNode(censusOptions.breakdown, report) : report;
 });
diff --git a/devtools/shared/heapsnapshot/tests/unit/test_HeapAnalyses_takeCensus_05.js b/devtools/shared/heapsnapshot/tests/unit/test_HeapAnalyses_takeCensus_05.js
new file mode 100644
index 0000000..be7ee53
--- /dev/null
+++ b/devtools/shared/heapsnapshot/tests/unit/test_HeapAnalyses_takeCensus_05.js
@@ -0,0 +1,44 @@
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+// Test that the HeapAnalyses{Client,Worker} can take censuses and return
+// a CensusTreeNode.
+
+function run_test() {
+  run_next_test();
+}
+
+const BREAKDOWN = {
+  by: "internalType",
+  then: { by: "count", count: true, bytes: true }
+};
+
+add_task(function* () {
+  const client = new HeapAnalysesClient();
+
+  const snapshotFilePath = saveNewHeapSnapshot();
+  yield client.readHeapSnapshot(snapshotFilePath);
+  ok(true, "Should have read the heap snapshot");
+
+  const report = yield client.takeCensus(snapshotFilePath, {
+    breakdown: BREAKDOWN
+  });
+
+  const treeNode = yield client.takeCensus(snapshotFilePath, {
+    breakdown: BREAKDOWN
+  }, {
+    asTreeNode: true
+  });
+
+  ok(treeNode.children.length > 0, "treeNode has children");
+  ok(treeNode.children.every(type => {
+    return "name" in type &&
+           "bytes" in type &&
+           "count" in type;
+  }), "all of tree node's children have name, bytes, count");
+
+  compareCensusViewData(BREAKDOWN, report, treeNode,
+    "Returning census as a tree node represents same data as the report");
+
+  client.destroy();
+});
diff --git a/devtools/shared/heapsnapshot/tests/unit/xpcshell.ini b/devtools/shared/heapsnapshot/tests/unit/xpcshell.ini
index dd01c2a..e82d797 100644
--- a/devtools/shared/heapsnapshot/tests/unit/xpcshell.ini
+++ b/devtools/shared/heapsnapshot/tests/unit/xpcshell.ini
@@ -12,16 +12,17 @@ support-files =
 [test_census-tree-node-01.js]
 [test_census-tree-node-02.js]
 [test_census-tree-node-03.js]
 [test_HeapAnalyses_readHeapSnapshot_01.js]
 [test_HeapAnalyses_takeCensus_01.js]
 [test_HeapAnalyses_takeCensus_02.js]
 [test_HeapAnalyses_takeCensus_03.js]
 [test_HeapAnalyses_takeCensus_04.js]
+[test_HeapAnalyses_takeCensus_05.js]
 [test_HeapSnapshot_takeCensus_01.js]
 [test_HeapSnapshot_takeCensus_02.js]
 [test_HeapSnapshot_takeCensus_03.js]
 [test_HeapSnapshot_takeCensus_04.js]
 [test_HeapSnapshot_takeCensus_05.js]
 [test_HeapSnapshot_takeCensus_06.js]
 [test_HeapSnapshot_takeCensus_07.js]
 [test_HeapSnapshot_takeCensus_08.js]
-- 
2.3.1

